<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Portefeuille</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .header-title { font-size: 24px; font-weight: bold; color: #1a5490; }
        .header-subtitle { font-size: 13px; color: #666; }
        .date-picker-container { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .date-picker-label { font-size: 11px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
        #dateActuelle { padding: 8px 12px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; color: #1a5490; }
        .situation-container { display: grid; grid-template-columns: 1fr 1.15fr 1fr; gap: 25px; margin-bottom: 40px; }
        .situation-box { padding: 14px; border-radius: 6px; }
        .situation-initial { background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); border-left: 4px solid #1a5490; }
        .situation-target { background: linear-gradient(135deg, #fff3e0 0%, #fff9f5 100%); border-left: 4px solid #ff9800; }
        .situation-current { background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-left: 4px solid #4caf50; }
        .situation-box h3 { font-size: 13px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; color: #666; letter-spacing: 0.5px; }
        .situation-box .row { margin-bottom: 7px; display: flex; justify-content: space-between; align-items: center; gap: 10px;
            flex-wrap: nowrap;
            align-items: baseline;
        }
        .situation-box .label { font-size: 11px; color: #666; flex: 1;
            white-space: nowrap;
            flex: 0 0 auto;
            max-width: 62%;
        }

        .situation-box .label br { display: none; }
        .situation-box .value { font-size: 14px; font-weight: bold; color: #1a1a1a; text-align: right; min-width: 120px;
            white-space: nowrap;
            flex: 0 0 auto;
        }
        .situation-initial .value { color: #1a5490; }
        .situation-target .value { color: #ff9800; }
        .situation-current .value { color: #4caf50; }
        .table-section { margin-top: 40px; }
        .table-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #1a5490; text-transform: uppercase; letter-spacing: 0.5px; }
        .table-controls { margin-bottom: 15px; display: flex; gap: 10px; }
        .btn-add { background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .btn-add:hover { background: #45a049; }
        .btn-print { background: #1a5490; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .btn-print:hover { background: #0d3a6f; }

        /* New Sync Button Style */
        .btn-sync {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }
        .btn-sync:hover { background: #1976D2; }
        .btn-sync .icon { font-size: 14px; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        thead { background: #1a5490 !important; color: white !important; }
        th { color: white !important; background: #1a5490 !important; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important; font-size: 11px !important; font-weight: 600 !important; }
        th { padding: 6px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border: none; }
        th.number { text-align: right; }
        td { padding: 6px; border-bottom: 1px solid #e0e0e0; font-size: 13px; }
        tbody tr:nth-child(odd) { background: #ffffff; }
        tbody tr:nth-child(even) { background: #f9f9f9; }
        tbody tr:hover { background: #f0f7ff; }
        .number { text-align: right; font-family: 'Courier New', monospace; }
        .positive { color: #4caf50; font-weight: 600; }
        .negative { color: #d32f2f; font-weight: 600; }
        .neutral { color: #666; }
        tr.total-row { background: #ecf0f6 !important; font-weight: bold; border-top: 2px solid #1a5490; }
        tr.section-row { background: #ecf0f6 !important; font-weight: bold; border-top: 1px solid #ddd; }
        .btn-delete { background: rgba(211, 47, 47, 0.3); color: #d32f2f; border: none; padding: 0; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1;
             display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .btn-delete:hover { background: rgba(211, 47, 47, 0.6); }
        input.editable { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-family: 'Courier New', monospace; font-size: 13px; }
        td.editable-cell { position: relative; padding: 0; }
        td.editable-cell span { display: block; padding: 6px; cursor: pointer; min-height: 20px; }
        td.editable-cell span:hover { background: #f0f7ff; }
        td.editable-cell input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px solid #1a5490; box-sizing: border-box; font-family: 'Courier New', monospace; font-size: 13px; padding: 6px; z-index: 10; }
        td.editable-cell input:focus { outline: none; }
        .mode-emploi { margin-top: 30px; padding: 20px; background: #f9f9f9; border-left: 4px solid #1a5490; border-radius: 4px; }
        .mode-emploi h4 { color: #1a5490; margin-bottom: 12px; font-size: 13px; }
        .mode-emploi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .mode-emploi ul { list-style: none; margin-left: 0; }
        .mode-emploi li { margin-bottom: 8px; padding-left: 20px; position: relative; font-size: 12px; color: #666; }
        .mode-emploi li::before { content: "‚úì"; position: absolute; left: 0; color: #4caf50; font-weight: bold; }

        @media print {

            /* Tighten spacing between last table row and footer */
            .table-section { margin-bottom: 0 !important; padding-bottom: 0 !important; }
            table { margin-bottom: 0 !important; }
            tbody tr:last-child td { border-bottom: 0 !important; }
            .footer { margin-top: 0 !important; padding-top: 0 !important; }
            .footer-text { margin: 0 !important; padding: 0 !important; }
            /* Avoid footer being forced to a new page or pushed down */
            .footer { page-break-before: auto !important; break-before: auto !important; }
            .table-section, table, tbody, tr, td { break-inside: auto; }

            .table-section { margin-top: 18px; }
            /* Force header table colors in print */
            thead th, thead th * { color: #fff !important; -webkit-text-fill-color: #fff !important; }
            thead, thead tr, thead th { background: #1a5490 !important; }

            .btn-sync { display: none !important; }
            /* ... existing print styles ... */
            body { background: white !important; color: black !important; padding: 2mm !important; margin: 0 !important; }
            .container { max-width: 100%; margin: 0 !important; padding: 4mm 6mm !important; box-shadow: none !important; }
            .header-top { border-bottom: 2px solid #1a5490 !important;
                padding-bottom: 10px;
            }
            .date-picker-container { display: flex !important; flex-direction: column !important; align-items: flex-end !important; gap: 2px !important; }
            .situation-container { gap: 10px !important; margin-bottom: 10px; }
            .situation-box { padding: 12px !important; border: 1px solid #ccc !important; }
            .situation-initial { background: #f0f4f9 !important; border-left: 4px solid #1a5490 !important; }
            .situation-target { background: #fff9f0 !important; border-left: 4px solid #ff9800 !important; }
            .situation-current { background: #f0f9f0 !important; border-left: 4px solid #4caf50 !important; }
            .table-controls, .mode-emploi, .btn-add, .btn-print, .btn-delete { display: none !important; }
            th { color: black !important; border-bottom: 2px solid #1a5490 !important; }
        }

        /* Inline editing */
        .editable-inline { cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.15s; display: inline-block; }
        .editable-inline:hover { background: rgba(33, 150, 243, 0.06); }
        .editable-inline.editing { background: transparent; padding: 0; }
        .editable-inline.editing input { border: 2px solid #2196f3; padding: 4px 8px; border-radius: 4px; font-size: inherit; font-family: inherit; font-weight: inherit; color: inherit; background: white; outline: none; width: auto; min-width: 120px; }
            .footer {
            margin-top: 5px;
            margin-bottom: 0px;
            text-align: center;
            font-size: 13px;
            color: #666;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .footer-text {
            font: inherit;
            color: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-top">
            <div>
                <div class="header-title"><span class="editable-inline" id="titre-app" data-field="titre">Mon Portefeuille</span></div>
                <div class="header-subtitle">Compte <span class="editable-inline" id="compte-num" data-field="compteNum">Num√©ro Compte</span> | <span class="editable-inline" id="compte-nom" data-field="compteNom">Nom Titulaire</span></div>
            </div>
            <div class="date-picker-container">
                <span class="date-picker-label">Date de mise √† jour</span>
                <span class="value"><span class="editable-inline" id="dateActuelle" data-field="initDate" data-type="date">JJ/MM/AAAA</span></span>
            </div>
        </div>

        <div class="situation-container">
            <!-- INITIAL -->
            <div class="situation-box situation-initial">
                <h3>Situation Initiale</h3>
                <div class="row"><span class="label">Date</span> <span class="value"><span class="editable-inline" id="init-date" data-field="initDate" data-type="date">JJ/MM/AAAA</span></span></div>
                <div class="row"><span class="label">Valeur Totale</span> <span class="value"><span class="editable-inline" id="init-total" data-field="initTotal" data-type="euro">0,00 ‚Ç¨</span></span></div>
                <div class="row"><span class="label">dont Titres</span> <span class="value" style="font-size: 13px;"><span class="editable-inline" id="init-titres" data-field="initTitres" data-type="euro">0,00 ‚Ç¨</span></span></div>
                <div class="row"><span class="label">dont Esp√®ces</span> <span class="value" style="font-size: 13px;"><span class="editable-inline" id="init-especes" data-field="initEspeces" data-type="euro">0,00 ‚Ç¨</span></span></div>
            </div>

            <!-- CIBLE -->
            <div class="situation-box situation-target">
                <h3>Cible Objectif</h3>
                <div class="row"><span class="label">Rendement %</span> <span class="value"><span class="editable-inline" id="rendementPct" data-type="pct">0,00 %</span></span></div>
                <div class="row"><span class="label">Valeur Cible</span> <span class="value"><span class="editable-inline" id="valeurCible" data-type="euro">0,00 ‚Ç¨</span></span></div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <div class="row"><span class="label">Manquant (‚Ç¨)</span> <span class="value" style="font-size: 13px;" id="manquantEuro">0,00 ‚Ç¨</span></div>
                    <div class="row"><span class="label">Manquant (%)</span> <span class="value" style="font-size: 13px;" id="manquantPct">0,00 %</span></div>
                </div>
            </div>

            <!-- ACTUELLE -->
            <div class="situation-box situation-current">
                <h3>Situation Actuelle</h3>
                <div class="row"><span class="label">Valeur Totale</span> <span class="value" id="valeurTotaleActuelle">0,00 ‚Ç¨</span></div>
                <div class="row"><span class="label">dont Titres</span> <span class="value" style="font-size: 13px;" id="titresActuels">0,00 ‚Ç¨</span></div>
                <div class="row"><span class="label">dont Esp√®ces</span> <span class="value" style="font-size: 13px;" id="especesActuelles">0,00 ‚Ç¨</span></div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <div class="row"><span class="label">Rendement Actuel</span> <span class="value" style="font-size: 13px;" id="rendementActuel">0,00 %</span></div>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-title">D√©tail des Positions</div>
            <div class="table-controls">
                <button class="btn-add" onclick="ajouterLigne()">+ Ajouter Position</button>
                <button class="btn-print" onclick="imprimerTableau()">üñ®Ô∏è Imprimer / PDF</button>
                <button class="btn-sync" onclick="handleSync()" title="Synchroniser avec dossier local">
                    <span class="icon">üîÑ</span> Synchronisation
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Code</th>
                        <th class="number">Quantit√©</th>
                        <th class="number">PRU (‚Ç¨)</th>
                        <th class="number">Cours du Jour (‚Ç¨)</th>
                        <th class="number">Valeur (‚Ç¨)</th>
                        <th class="number">+/- Values (‚Ç¨)</th>
                        <th class="number">Perf %</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="mode-emploi">
            <h4>üí° Mode d'emploi</h4>
            <div class="mode-emploi-grid">
                <ul>
                    <li><strong>Date :</strong> Choisissez la date mise √† jour</li>
                    <li><strong>Rendement % :</strong> Cible auto-calcul√©e</li>
                    <li><strong>Valeur Cible :</strong> Rendement auto-calcul√©</li>
                    <li><strong>Clic cellule :</strong> √âditer valeur</li>
                </ul>
                <ul>
                    <li><strong>Ajouter :</strong> "+ Ajouter Position"</li>
                    <li><strong>Supprimer :</strong> Bouton rond rouge</li>
                    <li><strong>Imprimer :</strong> "üñ®Ô∏è Imprimer / PDF"</li>
                    <li><strong>Automatique :</strong> Toutes valeurs recalcul√©es ‚úì</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Check Storage Availability
        try {
            console.log('Saved to LS');
            localStorage.setItem('test', '1');
            localStorage.removeItem('test');
        } catch(e) {
            alert("‚ö†Ô∏è Attention : Le stockage local est d√©sactiv√© ou restreint par votre navigateur.\nVos modifications ne seront pas conserv√©es apr√®s la fermeture si vous n'exportez pas en JSON.");
        }

        // Donn√©es initiales par d√©faut (si rien en local)
        let positions = [];

        let especes = 0;
        let valeurInitiale = 0; // This might be overwritten by UI load

        // ================== Formatage ==================
        function formatEur(num) {
            if (isNaN(num) || num === null || num === undefined) return "0,00 ‚Ç¨";
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        }
        function formatPct(num) {
            if (isNaN(num) || num === null || num === undefined) return "0,00%";
            return (num * 100).toFixed(2).replace('.', ',') + '%';
        }

        // ================== Manquants ==================
        function updateManquants(cibleText, actuelleText) {
            const parseNum = (txt) => {
                if (!txt) return 0;
                return parseFloat(String(txt).replace(/\s/g, '').replace('‚Ç¨', '').replace('%', '').replace(',', '.'));
            };
            const cibleVal = parseNum(cibleText);
            const actuelleVal = parseNum(actuelleText);
            const manquant = cibleVal - actuelleVal;
            const manquantPct = cibleVal !== 0 ? (manquant / cibleVal) * 100 : 0;

            const mEuro = document.getElementById('manquantEuro');
            if (mEuro) mEuro.textContent = manquant.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
            const mPct = document.getElementById('manquantPct');
            if (mPct) mPct.textContent = manquantPct.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
        }

        // ================== SYNC / STORAGE LOGIC ==================
        function getDataModel() {
            const getVal = (id) => document.getElementById(id) ? document.getElementById(id).textContent : '';
            const getValInput = (id) => {
                const el = document.getElementById(id);
                if (!el) return '';
                return el.tagName === 'INPUT' ? el.value : el.textContent;
            };

            return {
                timestamp: Date.now(),
                meta: {
                    titre: getVal('titre-app'),
                    compteNum: getVal('compte-num'),
                    compteNom: getVal('compte-nom'),
                    dateMiseAJour: getValInput('dateActuelle')
                },
                initial: {
                    date: getValInput('init-date'),
                    total: getValInput('init-total'),
                    titres: getValInput('init-titres'),
                    especes: getValInput('init-especes')
                },
                cible: {
                    rendementPct: getValInput('rendementPct'),
                    valeurCible: getValInput('valeurCible')
                },
                actuel: {
                    especes: especes
                },
                positions: positions
            };
        }

        function loadDataModel(data) {
            if (!data) return;
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'INPUT') el.value = val;
                    else el.textContent = val;
                }
            };
            // Meta
            if (data.meta) {
                setVal('titre-app', data.meta.titre);
                setVal('compte-num', data.meta.compteNum);
                setVal('compte-nom', data.meta.compteNom);
                setVal('dateActuelle', data.meta.dateMiseAJour);
            }
            // Initial
            if (data.initial) {
                setVal('init-date', data.initial.date);
                setVal('init-total', data.initial.total);
                setVal('init-titres', data.initial.titres);
                setVal('init-especes', data.initial.especes);
            }
            // Cible
            if (data.cible) {
                setVal('rendementPct', data.cible.rendementPct);
                setVal('valeurCible', data.cible.valeurCible);
            }
            // Actuel & Positions
            if (data.actuel) especes = parseFloat(data.actuel.especes) || 0;
            if (data.positions) positions.splice(0, positions.length, ...data.positions);

            // Refresh
            renderTable();
            // Force update manquants
            const cibleEl = document.getElementById('valeurCible');
            const actuEl = document.getElementById('valeurTotaleActuelle');
            if (cibleEl && actuEl) updateManquants(cibleEl.textContent, actuEl.textContent);

            // Save local
            console.log('Saved to LS');
            localStorage.setItem('cto_data', JSON.stringify(data));
        }

        function saveToLocalStorage() {
            const data = getDataModel();
            console.log('Saved to LS');
            localStorage.setItem('cto_data', JSON.stringify(data));
        }

        
        // ================== SYNC LOGIC (UNIVERSAL) ==================

        async function handleSync() {
            // Tenter la m√©thode moderne (Chrome/Edge)
            if (window.showDirectoryPicker) {
                try {
                    await smartSyncChrome();
                } catch (err) {
                    console.warn("Smart Sync failed, falling back", err);
                    showModal();
                }
            } else {
                // Fallback universel (Firefox, Safari)
                showModal();
            }
        }

        function showModal() {
            document.getElementById('syncModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('syncModal').style.display = 'none';
        }

        // --- M√©thodes Manuelles (Fallback) ---
        function manualSave() {
            saveToLocalStorage();
            const data = getDataModel();
            const num = data.meta.compteNum.replace(/[^a-z0-9]/gi, '_');
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10);
            const timeStr = now.getHours().toString().padStart(2,'0') + now.getMinutes().toString().padStart(2,'0');
            const fileName = `${num}_${dateStr}_${timeStr}.json`;

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeModal();
        }

        function triggerLoad() {
            document.getElementById('jsonInput').click();
        }

        function manualLoad(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    console.log("JSON charg√©:", content.substring(0, 100) + "...");
                    const json = JSON.parse(content);

                    if (!json || typeof json !== 'object') throw new Error("Format invalide");

                    if (confirm("Charger les donn√©es du fichier ?\nCela √©crasera les donn√©es actuelles.")) {
                        loadDataModel(json);
                        saveToLocalStorage(); // Force save immediately
                        alert("‚úÖ Donn√©es charg√©es avec succ√®s !");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Erreur : Fichier JSON invalide ou corrompu.\n" + err.message);
                }
                closeModal();
                input.value = ''; // reset
            };
            reader.readAsText(file);
        }

        // --- M√©thode Smart (Chrome Only) ---
        async function smartSyncChrome() {
            // 1. Acc√®s dossier
            const dirHandle = await window.showDirectoryPicker({ id: 'cto_sync_folder', mode: 'readwrite' });

            // 2. R√©cup√©rer Local Data
            const localDataStr = localStorage.getItem('cto_data');
            const localData = localDataStr ? JSON.parse(localDataStr) : null;
            const localTs = localData ? (localData.timestamp || 0) : 0;

            // 3. Scanner dossier
            const compteNum = document.getElementById('compte-num').textContent.trim();
            let latestFileHandle = null;
            let latestFileTs = 0;
            let latestFileData = null;

            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file' && entry.name.endsWith('.json') && entry.name.includes(compteNum)) {
                    const file = await entry.getFile();
                    const text = await file.text();
                    try {
                        const json = JSON.parse(text);
                        if (json.timestamp > latestFileTs) {
                            latestFileTs = json.timestamp;
                            latestFileHandle = entry;
                            latestFileData = json;
                        }
                    } catch (e) { console.warn("JSON invalide", entry.name); }
                }
            }

            // 4. Comparaison
            if (latestFileData && latestFileTs > localTs) {
                if (confirm(`Une version plus r√©cente existe (du ${new Date(latestFileTs).toLocaleString()}).\nVoulez-vous charger cette version ?`)) {
                    loadDataModel(latestFileData);
                    alert("‚úÖ Donn√©es charg√©es depuis le fichier !");
                } else {
                     await exportToJsonChrome(dirHandle);
                }
            } else {
                await exportToJsonChrome(dirHandle);
            }
        }

        async function exportToJsonChrome(dirHandle) {
            saveToLocalStorage();
            const data = getDataModel();
            const num = data.meta.compteNum.replace(/[^a-z0-9]/gi, '_');
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10);
            const timeStr = now.getHours().toString().padStart(2,'0') + now.getMinutes().toString().padStart(2,'0');
            const fileName = `${num}_${dateStr}_${timeStr}.json`;

            const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
            alert(`‚úÖ Sauvegarde r√©ussie : ${fileName}`);
        }

        // Init: Load from LS
        window.addEventListener('DOMContentLoaded', () => {
            setupInlineEditing(); // Init UI listeners

            const localData = localStorage.getItem('cto_data');
            if (localData) {
                try {
                    console.log("Restoring from LS...");
                    const parsed = JSON.parse(localData);
                    if (parsed && parsed.positions) {
                         loadDataModel(parsed);
                    } else {
                         console.warn("LS data corrupt, init empty");
                         renderTable();
                    }
                } catch(e) { 
                    console.error("Erreur chargement LS", e); 
                    renderTable();
                }
            } else {
                console.log("No data in LS, starting empty.");
                renderTable();
            }
        });

        // ================== RENDER ==================
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            let totalValeur = 0;
            let totalPlusValues = 0;

            positions.forEach((pos, idx) => {
                const valeur = pos.qty * pos.cours;
                const plusValues = valeur - (pos.qty * pos.pru);
                const perf = pos.qty === 0 ? 0 : (plusValues / (pos.qty * pos.pru));

                totalValeur += valeur;
                totalPlusValues += plusValues;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable-cell"><span onclick="enableEdit(this, 'nom', ${idx})">${pos.nom}</span></td>
                    <td class="editable-cell"><span onclick="enableEdit(this, 'code', ${idx})">${pos.code}</span></td>
                    <td class="number editable-cell"><span onclick="enableEdit(this, 'qty', ${idx})">${pos.qty}</span></td>
                    <td class="number editable-cell"><span onclick="enableEdit(this, 'pru', ${idx})">${pos.pru.toFixed(3)}</span></td>
                    <td class="number editable-cell"><span onclick="enableEdit(this, 'cours', ${idx})">${pos.cours.toFixed(3)}</span></td>
                    <td class="number">${formatEur(valeur)}</td>
                    <td class="number ${plusValues >= 0 ? 'positive' : 'negative'}">${formatEur(plusValues)}</td>
                    <td class="number ${pos.qty === 0 ? 'neutral' : (perf >= 0 ? 'positive' : 'negative')}">${pos.qty === 0 ? '-' : formatPct(perf)}</td>
                    <td><button class="btn-delete" onclick="supprimerLigne(${idx})">√ó</button></td>
                `;
                tableBody.appendChild(row);
            });

            // TOTAL TITRES
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="5" style="text-align: left;"><strong>TOTAL TITRES</strong></td>
                <td class="number"><strong>${formatEur(totalValeur)}</strong></td>
                <td class="number ${totalPlusValues >= 0 ? 'positive' : 'negative'}"><strong>${formatEur(totalPlusValues)}</strong></td>
                <td class="number ${totalValeur === 0 ? 'neutral' : (totalPlusValues/totalValeur >= 0 ? 'positive' : 'negative')}"><strong>${totalValeur === 0 ? '-' : formatPct(totalPlusValues / totalValeur)}</strong></td>
                <td></td>
            `;
            tableBody.appendChild(totalRow);

            // ESP√àCES
            const especesRow = document.createElement('tr');
            especesRow.className = 'section-row';
            especesRow.innerHTML = `
                <td colspan="5" style="text-align: left;"><strong>ESP√àCES</strong></td>
                <td class="number editable-cell"><span id="especesDisplay" onclick="enableEditEspeces()">${formatEur(especes)}</span></td>
                <td colspan="3"></td>
            `;
            tableBody.appendChild(especesRow);

            // VALEUR TOTALE
            const globalRow = document.createElement('tr');
            globalRow.className = 'total-row';
            const valeurGlobale = totalValeur + especes;
            globalRow.innerHTML = `
                <td colspan="5" style="text-align: left;"><strong>VALEUR TOTALE PORTEFEUILLE</strong></td>
                <td class="number"><strong>${formatEur(valeurGlobale)}</strong></td>
                <td class="number ${totalPlusValues >= 0 ? 'positive' : 'negative'}"><strong>${formatEur(totalPlusValues)}</strong></td>
                <td class="number ${valeurGlobale === 0 ? 'neutral' : (totalPlusValues/valeurGlobale >= 0 ? 'positive' : 'negative')}"><strong>${valeurGlobale === 0 ? '-' : formatPct(totalPlusValues / valeurGlobale)}</strong></td>
                <td></td>
            `;
            tableBody.appendChild(globalRow);

            // Header Stats
            document.getElementById('valeurTotaleActuelle').innerText = formatEur(valeurGlobale);
            document.getElementById('titresActuels').innerText = formatEur(totalValeur);
            document.getElementById('especesActuelles').innerText = formatEur(especes);

            // Rendement
            const initTotalEl = document.getElementById('init-total');
            const initVal = parseFloat(String(initTotalEl ? initTotalEl.textContent : '0').replace(/\s/g, '').replace('‚Ç¨', '').replace(',', '.'));

            if (initVal > 0) {
                 const rendementActuel = ((valeurGlobale - initVal) / initVal) * 100;
                 document.getElementById('rendementActuel').innerText = formatPct(rendementActuel / 100);
            }

            // Manquants Update
            const cibleEl = document.getElementById('valeurCible');
            if (cibleEl) {
                updateManquants(cibleEl.textContent, formatEur(valeurGlobale));
            }

            // Listeners
            document.querySelectorAll('td.editable-cell span').forEach(span => {
                span.addEventListener('click', (e) => { e.stopPropagation(); });
            });
            const especesDisplay = document.getElementById('especesDisplay');
            if (especesDisplay) especesDisplay.addEventListener('dblclick', enableEditEspeces);

            // AUTO-SAVE
            saveToLocalStorage();
        }

        // ================== EDIT FUNCTIONS ==================
        function enableEdit(spanElement, field, idx) {
            const currentValue = spanElement.innerText;
            const cell = spanElement.parentElement;
            spanElement.style.display = 'none';
            const input = document.createElement('input');
            input.type = field === 'nom' || field === 'code' ? 'text' : 'number';
            input.value = currentValue;
            if (field !== 'nom' && field !== 'code') input.step = '0.001';
            input.className = 'editable';
            cell.appendChild(input);
            input.focus();
            input.select();

            function saveChange() {
                const value = field === 'nom' || field === 'code' ? input.value : (parseFloat(input.value) || 0);
                if (field === 'qty') positions[idx].qty = value;
                else if (field === 'pru') positions[idx].pru = value;
                else if (field === 'cours') positions[idx].cours = value;
                else if (field === 'nom') positions[idx].nom = value;
                else if (field === 'code') positions[idx].code = value;
                input.remove();
                spanElement.style.display = 'block';
                renderTable();
            }
            input.addEventListener('blur', saveChange);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveChange();
                else if (e.key === 'Escape') { input.remove(); spanElement.style.display = 'block'; }
            });
        }

        function enableEditEspeces() {
            const display = document.getElementById('especesDisplay');
            if (!display) return;
            display.style.display = 'none';
            const cell = display.parentElement;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = especes;
            input.step = '0.01';
            input.className = 'editable';
            cell.appendChild(input);
            input.focus();
            input.select();

            function saveEspecesChange() {
                especes = parseFloat(input.value) || 0;
                input.remove();
                display.style.display = 'block';
                renderTable();
            }
            input.addEventListener('blur', saveEspecesChange);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveEspecesChange();
                else if (e.key === 'Escape') { input.remove(); display.style.display = 'block'; }
            });
        }

        function ajouterLigne() {
            positions.push({ nom: "NOUVELLE POSITION", code: "NEW", qty: 0, pru: 0, cours: 0 });
            renderTable();
            saveToLocalStorage();
            saveToLocalStorage();
        }
        function supprimerLigne(idx) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ligne ?')) {
                positions.splice(idx, 1);
                renderTable();
                saveToLocalStorage();
            }
        }
        function imprimerTableau() { window.print(); }

        // ================== INLINE HEADER EDIT ==================
        function setupInlineEditing() {
            document.querySelectorAll('.editable-inline').forEach(el => {
                el.addEventListener('click', function() {
                    if (this.classList.contains('editing')) return;
                    startEdit(this);
                });
            });
        }

        function startEdit(element) {
            element.classList.add('editing');
            const currentText = element.textContent.trim();
            const dataType = element.dataset.type || 'text';
            let value = currentText;
            if (dataType === 'euro' || dataType === 'pct') value = currentText.replace(/\s/g, '').replace('‚Ç¨', '').replace('%', '').replace(',', '.');
            const input = document.createElement('input');
            input.type = dataType === 'date' ? 'date' : 'text';
            input.value = value;
            input.style.width = '100%';
            input.style.textAlign = 'right';
            if (dataType === 'date') {
                const parts = currentText.split('/');
                if (parts.length === 3) input.value = parts[2] + '-' + parts[1] + '-' + parts[0];
            }
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            let finished = false;

            function finishEdit() {
                if (finished) return;
                finished = true;
                const rawValue = input.value.trim();
                element.classList.remove('editing');
                const parseNum = (txt) => {
                    if (!txt) return NaN;
                    return parseFloat(txt.replace(/\s/g, '').replace('‚Ç¨', '').replace('%', '').replace(',', '.'));
                };
                const num = parseNum(rawValue);

                if (dataType === 'euro') {
                    if (!isNaN(num)) {
                        element.textContent = num.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
                        if (element.id === 'valeurCible') {
                            const initEl = document.getElementById('init-total');
                            const initVal = parseNum(initEl ? initEl.textContent : '0');
                            if (initVal > 0) {
                                const newRend = ((num - initVal) / initVal) * 100;
                                const rendEl = document.getElementById('rendementPct');
                                if (rendEl) rendEl.textContent = newRend.toFixed(2).replace('.', ',') + ' %';
                            }
                            const actuEl = document.getElementById('valeurTotaleActuelle');
                            updateManquants(element.textContent, actuEl ? actuEl.textContent : '0');
                        }
                    } else element.innerHTML = currentText; // Fallback to old text roughly
                } else if (dataType === 'pct') {
                    if (!isNaN(num)) {
                        element.textContent = num.toFixed(2).replace('.', ',') + ' %';
                        if (element.id === 'rendementPct') {
                            const initEl = document.getElementById('init-total');
                            const initVal = parseNum(initEl ? initEl.textContent : '0');
                            if (initVal > 0) {
                                const newCible = initVal * (1 + num / 100);
                                const cibleEl = document.getElementById('valeurCible');
                                if (cibleEl) {
                                    cibleEl.textContent = newCible.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
                                    const actuEl = document.getElementById('valeurTotaleActuelle');
                                    updateManquants(cibleEl.textContent, actuEl ? actuEl.textContent : '0');
                                }
                            }
                        }
                    } else element.innerHTML = currentText;
                } else if (dataType === 'date') {
                    const parts = rawValue.split('-');
                    if (parts.length === 3) element.textContent = parts[2] + '/' + parts[1] + '/' + parts[0];
                    else element.innerHTML = currentText;
                } else {
                    element.textContent = rawValue;
                }

                // AUTO-SAVE on header edit
                saveToLocalStorage();
            }
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                if (e.key === 'Escape') { finished = true; element.classList.remove('editing'); element.innerHTML = currentText; }
            });
        }

        // Final Init
        
    </script>

    <!-- Modal Fallback Universel -->
    <div id="syncModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:25px; border-radius:8px; width:320px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
            <h3 style="margin-bottom:10px; color:#1a5490; font-family:'Segoe UI', sans-serif;">Synchronisation</h3>
            <p style="margin-bottom:20px; font-size:13px; color:#666; line-height:1.4;">
                Votre navigateur (Firefox/Safari) ne permet pas la synchro automatique de dossier.
            </p>
            <button onclick="manualSave()" style="width:100%; margin-bottom:10px; padding:12px; background:#4caf50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:14px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <span>‚¨áÔ∏è</span> Sauvegarder (T√©l√©charger)
            </button>
            <button onclick="triggerLoad()" style="width:100%; margin-bottom:15px; padding:12px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:14px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <span>‚¨ÜÔ∏è</span> Charger un fichier
            </button>
            <button onclick="closeModal()" style="width:100%; padding:8px; background:transparent; color:#888; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-size:12px;">
                Annuler
            </button>
        </div>
    </div>
    <input type="file" id="jsonInput" accept=".json" style="display:none" onchange="manualLoad(this)">
</body>
<div class="footer"><span class="footer-text">¬© 2026, Damien SICHAUMETTE</span></div>
</html>

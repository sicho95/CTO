<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Portefeuille CTO - Suivi Dynamique</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f7fb;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .compte-info {
            margin-bottom: 15px;
            font-weight: bold;
        }
        .section {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .section-title {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .col {
            flex: 1;
            min-width: 180px;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        .label {
            font-size: 13px;
            color: #555;
        }
        .value {
            font-size: 16px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        input[type="number"] {
            text-align: right;
        }
        .small {
            font-size: 12px;
            color: #666;
        }
        .highlight {
            color: #0066cc;
        }
        .btn {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }
        .btn-add {
            background: #4caf50;
            color: white;
        }
        .btn-print {
            background: #2196f3;
            color: white;
        }
        .btn-save {
            background: #ff9800;
            color: white;
        }
        .btn-remove {
            background: #ff5252;
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            text-align: center;
            padding: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            font-size: 13px;
        }
        th {
            background: #eef2fb;
            text-align: left;
        }
        td.numeric {
            text-align: right;
        }
        td.editable {
            cursor: pointer;
        }
        .help {
            font-size: 12px;
            color: #555;
            margin-top: 10px;
        }
        .help-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 4px;
            background: #eee;
            margin-right: 4px;
        }
        .negative {
            color: #c62828;
        }
        .positive {
            color: #2e7d32;
        }
        .toolbar {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        /* Modale */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        .modal h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .modal-buttons {
            margin-top: 15px;
            text-align: right;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Portefeuille CTO - Suivi Dynamique</h1>
    <div class="compte-info" id="compte-info">
        Compte <span id="compte-numero">20001303001</span> | <span id="compte-nom">M. Jean SICHAUMETTE</span>
    </div>

    <div class="section">
        <div class="section-title">Date de mise √† jour</div>
        <div class="row">
            <div class="col">
                <div class="label">Date</div>
                <input type="date" id="date-mise-a-jour" />
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Situation Initiale</div>
        <div class="row">
            <div class="col">
                <div class="label">Valeur Totale</div>
                <input type="number" id="init-valeur-totale" step="0.01">
            </div>
            <div class="col">
                <div class="label">dont Titres</div>
                <input type="number" id="init-titres" step="0.01">
            </div>
            <div class="col">
                <div class="label">dont Esp√®ces</div>
                <input type="number" id="init-especes" step="0.01">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Cible Objectif</div>
        <div class="row">
            <div class="col">
                <div class="label">Rendement %</div>
                <input type="number" id="cible-rendement" step="0.01">
            </div>
            <div class="col">
                <div class="label">Valeur Cible</div>
                <input type="number" id="cible-valeur" step="0.01">
            </div>
            <div class="col">
                <div class="label">Manquant (‚Ç¨)</div>
                <div class="value" id="cible-manquant-euro">0,00 ‚Ç¨</div>
            </div>
            <div class="col">
                <div class="label">Manquant (%)</div>
                <div class="value" id="cible-manquant-pourcent">0,00%</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Situation Actuelle</div>
        <div class="row">
            <div class="col">
                <div class="label">Valeur Totale</div>
                <div class="value" id="actuel-valeur-totale">0,00 ‚Ç¨</div>
            </div>
            <div class="col">
                <div class="label">dont Titres</div>
                <div class="value" id="actuel-titres">0,00 ‚Ç¨</div>
            </div>
            <div class="col">
                <div class="label">dont Esp√®ces</div>
                <div class="value" id="actuel-especes">0,00 ‚Ç¨</div>
            </div>
            <div class="col">
                <div class="label">Rendement Actuel</div>
                <div class="value" id="actuel-rendement">0,00%</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">D√©tail des Positions</div>
        <div class="toolbar">
            <button class="btn btn-add" id="btn-add-position">+ Ajouter Position</button>
            <button class="btn btn-print" id="btn-print">üñ®Ô∏è Imprimer / PDF</button>
            <button class="btn btn-save" id="btn-save-json">üíæ Sauvegarde</button>
        </div>
        <table id="positions-table">
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Code</th>
                    <th>Quantit√©</th>
                    <th>PRU (‚Ç¨)</th>
                    <th>Cours du Jour (‚Ç¨)</th>
                    <th>Valeur (‚Ç¨)</th>
                    <th>+/- Values (‚Ç¨)</th>
                    <th>Perf %</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="positions-body">
            </tbody>
        </table>
    </div>

    <div class="section">
        <div class="section-title">üí° Mode d'emploi</div>
        <div class="help">
            <div class="help-title">Date :</div>
            Choisissez la date de mise √† jour du portefeuille.
        </div>
        <div class="help">
            <div class="help-title">Rendement % :</div>
            La cible est auto-calcul√©e √† partir de la situation initiale.
        </div>
        <div class="help">
            <div class="help-title">Valeur Cible :</div>
            La valeur cible ajuste le rendement cible.
        </div>
        <div class="help">
            <div class="help-title">Clic cellule :</div>
            Cliquez sur une cellule pour √©diter la valeur.
        </div>
        <div class="help">
            <div class="help-title">Ajouter :</div>
            Utilisez le bouton ¬´ + Ajouter Position ¬ª pour cr√©er une nouvelle ligne.
        </div>
        <div class="help">
            <div class="help-title">Supprimer :</div>
            Utilisez le bouton rond rouge √† droite de la ligne.
        </div>
        <div class="help">
            <div class="help-title">Imprimer :</div>
            Utilisez ¬´ üñ®Ô∏è Imprimer / PDF ¬ª pour g√©n√©rer un PDF.
        </div>
        <div class="help">
            <div class="help-title">Sauvegarde :</div>
            Utilisez ¬´ üíæ Sauvegarde ¬ª pour exporter un JSON complet du CTO (compte, montants, titres et esp√®ces).
        </div>
        <div class="help">
            <span class="badge">Automatique</span>
            Toutes les valeurs sont recalcul√©es √† chaque modification.
        </div>
    </div>

    <script>
        // --- Constantes cl√©s localStorage ---
        const STORAGE_KEY = 'cto_portefeuille_data_v1';
        const DIR_HANDLE_KEY = 'cto_directory_handle_v1';

        // --- Utilitaires de format ---
        function formatEuro(value) {
            if (isNaN(value)) return '0,00 ‚Ç¨';
            return value.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
        }

        function formatPercent(value) {
            if (isNaN(value)) return '0,00%';
            return value.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
        }

        function parseNumber(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            const normalized = value.replace(/\s/g, '').replace(',', '.').replace('‚Ç¨', '');
            const n = parseFloat(normalized);
            return isNaN(n) ? 0 : n;
        }

        // --- Gestion des positions ---
        function createEmptyPosition() {
            return {
                id: 'pos_' + Date.now() + '_' + Math.floor(Math.random() * 100000),
                position: '',
                code: '',
                quantite: 0,
                pru: 0,
                cours: 0,
                valeur: 0,
                plusMoins: 0,
                perf: 0
            };
        }

        function renderPositions(data) {
            const tbody = document.getElementById('positions-body');
            tbody.innerHTML = '';
            data.positions.forEach(pos => {
                const tr = document.createElement('tr');

                function addCell(property, editable, numeric) {
                    const td = document.createElement('td');
                    if (numeric) td.classList.add('numeric');
                    if (editable) td.classList.add('editable');
                    td.dataset.id = pos.id;
                    td.dataset.field = property;
                    const value = pos[property];

                    if (property === 'valeur') {
                        td.textContent = formatEuro(value);
                    } else if (property === 'plusMoins') {
                        td.textContent = formatEuro(value);
                        if (value < 0) td.classList.add('negative');
                        if (value > 0) td.classList.add('positive');
                    } else if (property === 'perf') {
                        td.textContent = formatPercent(value);
                        if (value < 0) td.classList.add('negative');
                        if (value > 0) td.classList.add('positive');
                    } else {
                        td.textContent = value;
                    }

                    if (editable) {
                        td.addEventListener('click', () => editCell(td));
                    }
                    tr.appendChild(td);
                }

                addCell('position', true, false);
                addCell('code', true, false);
                addCell('quantite', true, true);
                addCell('pru', true, true);
                addCell('cours', true, true);
                addCell('valeur', false, true);
                addCell('plusMoins', false, true);
                addCell('perf', false, true);

                const tdRemove = document.createElement('td');
                tdRemove.classList.add('numeric');
                const btnRemove = document.createElement('button');
                btnRemove.className = 'btn btn-remove';
                btnRemove.textContent = '√ó';
                btnRemove.addEventListener('click', () => removePosition(pos.id));
                tdRemove.appendChild(btnRemove);
                tr.appendChild(tdRemove);

                tbody.appendChild(tr);
            });
        }

        function editCell(td) {
            const currentValue = td.textContent.trim();
            const isNumeric = td.classList.contains('numeric') || ['quantite','pru','cours'].includes(td.dataset.field);
            const input = document.createElement('input');
            input.type = isNumeric ? 'number' : 'text';
            input.value = isNumeric ? parseNumber(currentValue) : currentValue;
            input.style.width = '100%';
            td.innerHTML = '';
            td.appendChild(input);
            input.focus();
            input.select();

            input.addEventListener('blur', () => {
                const newValue = input.value;
                const id = td.dataset.id;
                const field = td.dataset.field;
                const data = loadData();
                const pos = data.positions.find(p => p.id === id);
                if (!pos) return;

                if (['quantite','pru','cours'].includes(field)) {
                    pos[field] = parseNumber(newValue);
                } else {
                    pos[field] = newValue;
                }

                recalcPosition(pos);
                recalcGlobal(data);
                saveData(data);
                renderAll(data);
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        function recalcPosition(pos) {
            pos.valeur = pos.quantite * pos.cours;
            const investi = pos.quantite * pos.pru;
            pos.plusMoins = pos.valeur - investi;
            pos.perf = investi !== 0 ? (pos.plusMoins / investi) * 100 : 0;
        }

        function recalcAllPositions(data) {
            data.positions.forEach(recalcPosition);
        }

        function recalcGlobal(data) {
            let totalTitres = 0;
            data.positions.forEach(p => { totalTitres += p.valeur; });
            data.situationActuelle.titres = totalTitres;

            const init = data.situationInitiale;
            // Esp√®ces = valeur totale actuelle - valeur titres
            data.situationActuelle.especes = data.situationActuelle.valeurTotale - totalTitres;
            if (isNaN(data.situationActuelle.especes)) data.situationActuelle.especes = 0;

            // Rendement actuel par rapport √† la situation initiale
            const investiInitial = init.valeurTotale;
            if (investiInitial && investiInitial !== 0) {
                const diff = data.situationActuelle.valeurTotale - investiInitial;
                data.situationActuelle.rendement = (diff / investiInitial) * 100;
            } else {
                data.situationActuelle.rendement = 0;
            }

            // Objectif
            const cible = data.cible;
            cible.valeurCible = investiInitial * (1 + (cible.rendement / 100));
            const manquant = cible.valeurCible - data.situationActuelle.valeurTotale;
            cible.manquantEuro = manquant;
            cible.manquantPourcent = data.situationActuelle.valeurTotale !== 0 ?
                (manquant / data.situationActuelle.valeurTotale) * 100 : 0;
        }

        function renderGlobal(data) {
            document.getElementById('compte-numero').textContent = data.compte.numero;
            document.getElementById('compte-nom').textContent = data.compte.nom;
            document.getElementById('date-mise-a-jour').value = data.dateMiseAJour || '';

            document.getElementById('init-valeur-totale').value = data.situationInitiale.valeurTotale;
            document.getElementById('init-titres').value = data.situationInitiale.titres;
            document.getElementById('init-especes').value = data.situationInitiale.especes;

            document.getElementById('cible-rendement').value = data.cible.rendement;
            document.getElementById('cible-valeur').value = data.cible.valeurCible;

            document.getElementById('actuel-valeur-totale').textContent = formatEuro(data.situationActuelle.valeurTotale);
            document.getElementById('actuel-titres').textContent = formatEuro(data.situationActuelle.titres);
            document.getElementById('actuel-especes').textContent = formatEuro(data.situationActuelle.especes);
            document.getElementById('actuel-rendement').textContent = formatPercent(data.situationActuelle.rendement);

            document.getElementById('cible-manquant-euro').textContent = formatEuro(data.cible.manquantEuro);
            document.getElementById('cible-manquant-pourcent').textContent = formatPercent(data.cible.manquantPourcent);
        }

        function renderAll(data) {
            renderGlobal(data);
            renderPositions(data);
        }

        function removePosition(id) {
            const data = loadData();
            data.positions = data.positions.filter(p => p.id !== id);
            recalcAllPositions(data);
            recalcGlobal(data);
            saveData(data);
            renderAll(data);
        }

        // --- Persistance localStorage ---
        function defaultData() {
            return {
                compte: {
                    numero: '20001303001',
                    nom: 'M. Jean SICHAUMETTE'
                },
                dateMiseAJour: '',
                situationInitiale: {
                    valeurTotale: 0,
                    titres: 0,
                    especes: 0
                },
                cible: {
                    rendement: 0,
                    valeurCible: 0,
                    manquantEuro: 0,
                    manquantPourcent: 0
                },
                situationActuelle: {
                    valeurTotale: 0,
                    titres: 0,
                    especes: 0,
                    rendement: 0
                },
                positions: [],
                lastUpdated: Date.now()
            };
        }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return defaultData();
            try {
                const data = JSON.parse(raw);
                if (!data.positions) data.positions = [];
                if (!data.compte) data.compte = { numero: '', nom: '' };
                if (typeof data.lastUpdated !== 'number') data.lastUpdated = Date.now();
                return data;
            } catch (e) {
                return defaultData();
            }
        }

        function saveData(data) {
            data.lastUpdated = Date.now();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // --- Gestion des champs "form" pour maj data ---
        function attachFormEvents() {
            const data = loadData();
            document.getElementById('date-mise-a-jour').addEventListener('change', (e) => {
                const d = loadData();
                d.dateMiseAJour = e.target.value;
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });

            document.getElementById('init-valeur-totale').addEventListener('change', (e) => {
                const d = loadData();
                d.situationInitiale.valeurTotale = parseNumber(e.target.value);
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });

            document.getElementById('init-titres').addEventListener('change', (e) => {
                const d = loadData();
                d.situationInitiale.titres = parseNumber(e.target.value);
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });

            document.getElementById('init-especes').addEventListener('change', (e) => {
                const d = loadData();
                d.situationInitiale.especes = parseNumber(e.target.value);
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });

            document.getElementById('cible-rendement').addEventListener('change', (e) => {
                const d = loadData();
                d.cible.rendement = parseNumber(e.target.value);
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });

            document.getElementById('cible-valeur').addEventListener('change', (e) => {
                const d = loadData();
                d.cible.valeurCible = parseNumber(e.target.value);
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });
        }

        // --- Export JSON complet ---
        function exportJson() {
            const data = loadData();
            recalcAllPositions(data);
            recalcGlobal(data);
            data.lastUpdated = Date.now();

            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const filename = `CTO_${yyyy}-${mm}-${dd}-${hh}${min}.json`;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Import depuis un fichier JSON (handle) ---
        async function importFromFileHandle(fileHandle) {
            const file = await fileHandle.getFile();
            const text = await file.text();
            let json;
            try {
                json = JSON.parse(text);
            } catch (e) {
                console.error('JSON invalide', e);
                return;
            }
            if (!json || typeof json !== 'object') return;

            const local = loadData();
            const jsonTs = typeof json.lastUpdated === 'number' ? json.lastUpdated : 0;
            const localTs = typeof local.lastUpdated === 'number' ? local.lastUpdated : 0;

            if (jsonTs <= localTs) {
                // Local plus r√©cent, on ne fait rien
                return;
            }

            // Remplacement complet par le JSON (tout : compte, montants, cibles, positions)
            const merged = {
                compte: json.compte || local.compte,
                dateMiseAJour: json.dateMiseAJour || local.dateMiseAJour,
                situationInitiale: json.situationInitiale || local.situationInitiale,
                cible: json.cible || local.cible,
                situationActuelle: json.situationActuelle || local.situationActuelle,
                positions: Array.isArray(json.positions) ? json.positions : local.positions,
                lastUpdated: jsonTs || Date.now()
            };

            saveData(merged);
            renderAll(merged);
        }

        // --- Gestion du dossier via File System Access API ---
        async function getDirectoryHandle() {
            // On ne peut pas directement s√©rialiser un DirectoryHandle (structured clone uniquement),
            // donc on le stocke via localStorage en utilisant l'API moderne (si support√©e)
            // Ici : on stocke juste un flag, et on redemande si n√©cessaire.
            return await window.showDirectoryPicker({
                id: 'cto-folder',
                mode: 'readwrite'
            });
        }

        async function findLatestCtoJson(dirHandle) {
            let latestHandle = null;
            let latestTime = 0;

            for await (const [name, handle] of dirHandle.entries()) {
                if (handle.kind === 'file' && /^CTO_\d{4}-\d{2}-\d{2}-\d{4}\.json$/.test(name)) {
                    const file = await handle.getFile();
                    let ts = 0;
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        ts = typeof data.lastUpdated === 'number' ? data.lastUpdated : file.lastModified;
                    } catch (e) {
                        ts = file.lastModified;
                    }
                    if (ts > latestTime) {
                        latestTime = ts;
                        latestHandle = handle;
                    }
                }
            }

            return { latestHandle, latestTime };
        }

        function showUpdateModal(onConfirm, message) {
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            const modal = document.createElement('div');
            modal.className = 'modal';

            modal.innerHTML = `
                <h3>Mise √† jour d√©tect√©e</h3>
                <p>${message}</p>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" id="modal-cancel">Annuler</button>
                    <button class="btn btn-save" id="modal-confirm">Mettre √† jour</button>
                </div>
            `;
            backdrop.appendChild(modal);
            document.body.appendChild(backdrop);

            modal.querySelector('#modal-cancel').addEventListener('click', () => {
                document.body.removeChild(backdrop);
            });

            modal.querySelector('#modal-confirm').addEventListener('click', async () => {
                await onConfirm();
                document.body.removeChild(backdrop);
            });
        }

        async function autoCheckJsonOnStartup() {
            if (!('showDirectoryPicker' in window)) {
                return; // Pas support√© (Safari/Firefox)
            }

            // On garde le handle en m√©moire globale (page courante)
            if (!window._ctoDirectoryHandle) {
                try {
                    window._ctoDirectoryHandle = await getDirectoryHandle();
                } catch (e) {
                    console.warn('Dossier CTO non d√©fini', e);
                    return;
                }
            }

            const dirHandle = window._ctoDirectoryHandle;
            const local = loadData();
            const localTs = typeof local.lastUpdated === 'number' ? local.lastUpdated : 0;

            const { latestHandle, latestTime } = await findLatestCtoJson(dirHandle);
            if (!latestHandle || latestTime <= localTs) {
                return; // Rien de plus r√©cent
            }

            const msg = `Un fichier JSON CTO plus r√©cent a √©t√© trouv√© dans le dossier. 
Souhaitez-vous mettre √† jour le portefeuille avec ce fichier ?`;

            showUpdateModal(async () => {
                await importFromFileHandle(latestHandle);
            }, msg.replace(/\n/g, '<br>'));
        }

        // --- Impression ---
        function printPage() {
            window.print();
        }

        // --- Initialisation ---
        window.addEventListener('load', async () => {
            let data = loadData();
            recalcAllPositions(data);
            recalcGlobal(data);
            renderAll(data);
            attachFormEvents();

            document.getElementById('btn-add-position').addEventListener('click', () => {
                const d = loadData();
                d.positions.push(createEmptyPosition());
                recalcAllPositions(d);
                recalcGlobal(d);
                saveData(d);
                renderAll(d);
            });

            document.getElementById('btn-print').addEventListener('click', printPage);
            document.getElementById('btn-save-json').addEventListener('click', exportJson);

            // Auto-check JSON plus r√©cent dans le dossier choisi
            await autoCheckJsonOnStartup();
        });
    </script>
</body>
</html>
